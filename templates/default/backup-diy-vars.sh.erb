#!/bin/bash

#
#  Dynamically generated by Chef on <%= node["fqdn"] %>
#  Local modifications will be overwritten by Chef.
#

CURL_OPTIONS="-L -s -f"

# Which database backup script to use (ex: mssql, postgresql, mysql, ebs-collocated, rds)
BACKUP_DATABASE_TYPE=<%= @database['type'] %>

# Which filesystem backup script to use (ex: rsync, ebs-home)
BACKUP_HOME_TYPE=<%= @backup_diy['backup_home_type'] %>

# Which archive backup script to use (ex: tar, tar-gpg)
BACKUP_ARCHIVE_TYPE=<%= @backup_diy['backup_archive_type'] %>

# Used by the scripts for verbose logging. If not true only errors will be shown.
STASH_VERBOSE_BACKUP=<%= @backup_diy['verbose'] ? 'TRUE' : 'FALSE' %>

# The base url used to access this stash instance. It cannot end on a '/'
STASH_URL=<%= @backup['baseurl'] %>

# Used in AWS backup / restore to tag snapshots. It cannot contain spaces and it must be under 100 characters long
INSTANCE_NAME=stash

# The username and password for the user used to make backups (and have this permission)
STASH_BACKUP_USER=<%= @backup['user'] %>
STASH_BACKUP_PASS=<%= @backup['password'] %>

# The name of the database used by this instance.
STASH_DB=<%= @database['name'] %>
# The path to stash home folder (with trailing /)
STASH_HOME=<%= File.join(node['stash']['home_path'], "/") %>

# OS level user and group information (typically: 'stash' for both)
STASH_UID=<%= node['stash']['user'] %>
STASH_GID=<%= node['stash']['user'] %>

# The path to working folder for the backup
STASH_BACKUP_ROOT=<%= @backup_diy['temp_path'] %>
<% if @database['type'] == 'postgresql' %>
STASH_BACKUP_DB=${STASH_BACKUP_ROOT}/stash-db/
<% else %>
STASH_BACKUP_DB=${STASH_BACKUP_ROOT}/stash-db.sql
<% end %>
STASH_BACKUP_HOME=${STASH_BACKUP_ROOT}/stash-home/

# The path to where the backup archives are stored
STASH_BACKUP_ARCHIVE_ROOT=<%= @backup['backup_path'] %>

# List of repo IDs which should not be excluded from backup
# It should be space separated: (2 5 88)
STASH_BACKUP_EXCLUDE_REPOS=(<%= @backup_diy['exclude_repos'].join(" ") %>)

<% case @database['type'] %>
<% when "postgresql" %>
# PostgreSQL options
POSTGRES_HOST=<%= @database['host'] %>
POSTGRES_USERNAME=postgres
POSTGRES_PASSWORD=<%= node['postgresql']['password']['postgres'] %>
POSTGRES_PORT=<%= @database['port'] %>
<% when "mysql" %>
# MySQL options
MYSQL_HOST=<%= @database['host'] %>
MYSQL_USERNAME=<%= @database['user'] %>
MYSQL_PASSWORD=<%= @database['password'] %>
MYSQL_BACKUP_OPTIONS=<%= @backup_diy['mysql_options'] || '' %>
<% end %>

# HipChat options
HIPCHAT_URL=<%= @backup_diy['hipchat_url'] %>
HIPCHAT_ROOM=<%= @backup_diy['hipchat_room'] %>
HIPCHAT_TOKEN=<%= @backup_diy['hipchat_token'] %>

<% if @backup_diy['backup_archive_type'] == 'tar-gpg' %>
# Options for the tar-gpg archive type
STASH_BACKUP_GPG_RECIPIENT=<%= @backup_diy['gpg_recipient'] %>
<% end %>
