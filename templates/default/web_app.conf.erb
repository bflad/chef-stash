#
#  Dynamically generated by Chef on <%= node["fqdn"] %>
#  Local modifications will be overwritten by Chef.
#
<VirtualHost *:<%= node['stash']['apache2']['port'] %>>
	<% if node['stash']['apache2']['virtual_host_name'] -%>
	ServerName <%= node['stash']['apache2']['virtual_host_name'] %>
	<% end -%>
	<% if node['stash']['apache2']['virtual_host_alias'] -%>
	<% virtual_host_aliases = node['stash']['apache2']['virtual_host_alias'].kind_of?(Array) ? node['stash']['apache2']['virtual_host_alias'] : [ node['stash']['apache2']['virtual_host_alias'] ] -%>
	<% virtual_host_aliases.each do |virtual_host_alias| -%>
	ServerAlias <%= virtual_host_alias %>
	<% end -%>
	<% end -%>
	DocumentRoot <%= node['stash']['install_path'] %>

  CustomLog <%= node['stash']['apache2']['access_log'] ? node['stash']['apache2']['access_log'] : "#{node['apache']['log_dir']}/stash-access.log" %> combined
  ErrorLog <%= node['stash']['apache2']['error_log'] ? node['stash']['apache2']['error_log'] : "#{node['apache']['log_dir']}/stash-error.log" %>
	LogLevel warn

	<Proxy *>
    <% if node['apache'] && node['apache']['version'] == '2.4' %>
		Require all granted
    <% else %>
		Order Deny,Allow
		Allow from all
    <% end %>
	</Proxy>
	ProxyPass        / http://localhost:<%= node['stash']['tomcat']['port'] %>/ connectiontimeout=5 timeout=300
	ProxyPassReverse / http://localhost:<%= node['stash']['tomcat']['port'] %>/
</VirtualHost>

<VirtualHost *:<%= node['stash']['apache2']['ssl']['port'] %>>
	<% if node['stash']['apache2']['virtual_host_name'] -%>
	ServerName <%= node['stash']['apache2']['virtual_host_name'] %>
	<% end -%>
	<% if node['stash']['apache2']['virtual_host_alias'] -%>
	<% virtual_host_aliases = node['stash']['apache2']['virtual_host_alias'].kind_of?(Array) ? node['stash']['apache2']['virtual_host_alias'] : [ node['stash']['apache2']['virtual_host_alias'] ] -%>
	<% virtual_host_aliases.each do |virtual_host_alias| -%>
	ServerAlias <%= virtual_host_alias %>
	<% end -%>
	<% end -%>
	DocumentRoot <%= node['stash']['install_path'] %>

  CustomLog <%= node['stash']['apache2']['ssl']['access_log'] ? node['stash']['apache2']['ssl']['access_log'] : "#{node['apache']['log_dir']}/stash-ssl-access.log" %> combined
  ErrorLog <%= node['stash']['apache2']['ssl']['error_log'] ? node['stash']['apache2']['ssl']['error_log'] : "#{node['apache']['log_dir']}/stash-ssl-error.log" %>
	LogLevel warn

	<Proxy *>
    <% if node['apache'] && node['apache']['version'] == '2.4' %>
		Require all granted
    <% else %>
		Order Deny,Allow
		Allow from all
    <% end %>
	</Proxy>
	ProxyPass        / http://localhost:<%= node['stash']['tomcat']['port'] %>/ connectiontimeout=5 timeout=300
	ProxyPassReverse / http://localhost:<%= node['stash']['tomcat']['port'] %>/

	SSLEngine on
	SSLCertificateFile <%= node['stash']['apache2']['ssl']['certificate_file'] %>
	SSLCertificateKeyFile <%= node['stash']['apache2']['ssl']['key_file'] %>
	<% if node['stash']['apache2']['ssl']['chain_file'] -%>
	SSLCertificateChainFile <%= node['stash']['apache2']['ssl']['chain_file'] %>
	<% end -%>
</VirtualHost>
