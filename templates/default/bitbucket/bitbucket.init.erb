#!/usr/bin/env bash
# Dynamically generated by Chef on <%= node["fqdn"] %>
# Local modifications will be overwritten by Chef.
#chkconfig: 2345 80 05
#description: Atlassian Bitbucket Server

### BEGIN INIT INFO
# Provides:          Bitbucket
# Required-Start:
# Required-Stop:
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Start Bitbucket daemon at boot time
# Description:       Start Bitbucket daemon at boot time
### END INIT INFO

# Location of application's base directory
BASE=<%= node['stash']['install_path'] %>/bitbucket

PIDFILE=/var/run/bitbucket/catalina.pid

if [ ! -d /var/run/bitbucket ]; then
    mkdir -p /var/run/bitbucket
    chown <%= node['stash']['user'] %>:<%= node['stash']['user'] %> /var/run/bitbucket
fi

start() {
    $BASE/bin/start-bitbucket.sh
}

stop() {
    $BASE/bin/stop-bitbucket.sh
}

status() {
    if [ -f $PIDFILE ]
    then
        PID=$(<$PIDFILE)
        if kill -0 $PID &>1 > /dev/null
        then
            echo "Bitbucket is running"
            exit 0
        fi
    fi

    echo "Bitbucket is not running"
    exit 1
}

# Bitbucket Linux service controller script
cd $BASE/bin

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    status)
        status
        ;;
    restart)
        stop
        start
        ;;
    *)
        echo "Usage: $0 {start|stop|status}"
        exit 1
        ;;
esac
